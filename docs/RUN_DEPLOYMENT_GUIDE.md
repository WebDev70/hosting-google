# Deploying to Google Kubernetes Engine (GKE)

This guide provides step-by-step instructions to deploy both the Node.js and Drupal applications to Google Kubernetes Engine (GKE).

---

### **Part 1: One-Time Google Cloud & Local Setup**

First, you need to set up your Google Cloud project and local environment to work with GKE.

**1. Enable Google Cloud APIs**
You need to enable the APIs for Kubernetes Engine and Artifact Registry (the modern replacement for Google Container Registry).

```bash
gcloud services enable container.googleapis.com
gcloud services enable artifactregistry.googleapis.com
```

**2. Install `kubectl`**
The `gcloud` command-line tool needs the Kubernetes command-line tool, `kubectl`, to interact with your cluster.

```bash
gcloud components install kubectl
```

**3. Create a GKE Cluster**
This command creates a small, cost-effective GKE cluster. For a real production environment, you would want to use a more robust configuration.

```bash
gcloud container clusters create drupal-cluster \
  --num-nodes=2 \
  --machine-type=e2-medium \
  --zone=us-central1-a
```
*This can take 5-10 minutes.*

**4. Create a Docker Repository in Artifact Registry**
This is where you will store your Docker images.

```bash
gcloud artifacts repositories create app-images \
  --repository-format=docker \
  --location=us-central1 \
  --description="Docker repository for my applications"
```

**5. Configure Docker Authentication**
This command configures your local Docker client to authenticate with your new Artifact Registry repository.

```bash
gcloud auth configure-docker us-central1-docker.pkg.dev
```

---

### **Part 2: Convert the Drupal `docker-compose.yml` to Kubernetes Manifests**

We'll use a tool called `kompose` to automatically convert your `docker-compose.yml` file into Kubernetes configuration files (manifests).

**1. Install `kompose`**
The easiest way to install it is to follow the official instructions on the Kompose website: [https://kompose.io/installation/](https://kompose.io/installation/)

For macOS, you can often use Homebrew:
```bash
brew install kompose
```

**2. Run `kompose` to Generate the Files**
Navigate into your `drupal` directory and run `kompose`.

```bash
cd drupal
kompose convert
```

This will create several files, such as:
*   `drupal-award2-deployment.yaml`
*   `mariadb-award2-deployment.yaml`
*   `adminer-award2-deployment.yaml`
*   `drupal-award2-service.yaml`
*   `mariadb-award2-service.yaml`
*   `adminer-service.yaml`
*   A persistent volume claim for MariaDB (e.g., `mariadb-award2-claim0-persistentvolumeclaim.yaml`).

**3. Review and Refine the Generated Manifests**
`kompose` gives you a great starting point, but you'll likely need to make a few adjustments. The most important one is exposing your services to the internet.

Open `drupal-award2-service.yaml` and `adminer-service.yaml`. In both files, find the line that says `type: ClusterIP` and change it to `type: LoadBalancer`.

*   **`ClusterIP`** means the service is only accessible inside the cluster (good for the database).
*   **`LoadBalancer`** tells Google Cloud to create a public IP address and a load balancer for the service so you can access it from the internet.

---

### **Part 3: Create Kubernetes Manifests for the Node.js App**

Now, create the Kubernetes configuration for your Node.js application.

**1. Create `node-deployment.yaml`**
In the root directory of your project, create a file named `node-deployment.yaml` with the following content:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: node-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: node-app
  template:
    metadata:
      labels:
        app: node-app
    spec:
      containers:
      - name: node-app-container
        image: "us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/node-app:latest"
        ports:
        - containerPort: 3000
```
*   **Important:** Replace `YOUR_PROJECT_ID` with your actual Google Cloud Project ID.

**2. Create `node-service.yaml`**
In the same directory, create a file named `node-service.yaml`:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: node-app-service
spec:
  type: LoadBalancer
  selector:
    app: node-app
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
```
This creates a public-facing load balancer for your Node.js app.

---

### **Part 4: Build and Deploy Everything to GKE**

Now we'll build the Docker images, push them to Artifact Registry, and deploy to GKE.

**1. Update Image Names in Drupal Manifests**
You need to edit the deployment YAML files generated by `kompose` to point to your Artifact Registry. Open `drupal-award2-deployment.yaml`, `mariadb-award2-deployment.yaml`, and `adminer-award2-deployment.yaml` and change the `image` field to match this pattern:

`us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/IMAGE_NAME:latest`

For example, in `drupal-award2-deployment.yaml`, the image would become:
`us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/drupal-award2:latest`

**2. Build and Push All Docker Images**

*   **Node.js App (from the root directory):**
    ```bash
    docker build -t us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/node-app:latest .
    docker push us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/node-app:latest
    ```

*   **Drupal Apps (from the `drupal` directory):**
    ```bash
    cd drupal
    docker build -f Dockerfile.drupal -t us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/drupal-award2:latest .
    docker build -f Dockerfile.mariadb -t us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/mariadb-award2:latest .
    docker build -f Dockerfile.adminer -t us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/adminer:latest .
    
    docker push us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/drupal-award2:latest
    docker push us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/mariadb-award2:latest
    docker push us-central1-docker.pkg.dev/YOUR_PROJECT_ID/app-images/adminer:latest
    ```
    *Again, remember to replace `YOUR_PROJECT_ID`.*

**3. Deploy to GKE**
Apply all the configuration files to your GKE cluster.

*   **From the `drupal` directory:**
    ```bash
    cd drupal
    kubectl apply -f .
    ```

*   **From the root directory:**
    ```bash
    cd .. 
    kubectl apply -f node-deployment.yaml
    kubectl apply -f node-service.yaml
    ```

---

### **Part 5: Verify the Deployment**

**1. Check the Status of Pods**
Pods are the running instances of your containers.

```bash
kubectl get pods
```
Wait until all pods show `Running`. This may take a few minutes.

**2. Get the Public IP Addresses for Your Services**
This command shows you the external IP addresses for your services that are exposed via a `LoadBalancer`.

```bash
kubectl get services
```
You will see an `EXTERNAL-IP` for `drupal-award2-service`, `adminer-service`, and `node-app-service`. It might take a few minutes for the IP addresses to become available.

You can then access your applications in your browser using these IP addresses.
